name: Update MacPorts Portfile
permissions:
    contents: read

on:
    repository_dispatch:
        types: [macports_release]
    workflow_dispatch:
        inputs:
            version:
                description: "Version to update (e.g., 2.0.1) - leave empty to use latest release"
                required: false
                type: string

jobs:
    update-portfile:
        runs-on: macos-latest
        steps:
            - name: Determine version
              id: version
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  if [ -n "${{ inputs.version }}" ]; then
                    # Manual trigger with specified version
                    VERSION="${{ inputs.version }}"
                    VERSION="${VERSION#v}"  # Remove 'v' prefix if present
                  elif [ -n "${{ github.event.release.tag_name }}" ]; then
                    # Release event
                    VERSION="${{ github.event.release.tag_name }}"
                    VERSION="${VERSION#v}"  # Remove 'v' prefix
                  else
                    # Manual trigger without version - get latest release
                    VERSION=$(gh release view --repo ${{ github.repository }} --json tagName -q '.tagName')
                    VERSION="${VERSION#v}"  # Remove 'v' prefix
                  fi
                  echo "version=${VERSION}" >> $GITHUB_OUTPUT
                  echo "Using version: ${VERSION}"

            - name: Update Portfile
              env:
                  MACPORTS_PORTS_TOKEN: ${{ secrets.MACPORTS_PORTS_TOKEN }}
              run: |
                  VERSION="${{ steps.version.outputs.version }}"

                  # Download pkg to calculate checksums
                  curl -L -o MiddleDrag.pkg "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/MiddleDrag.pkg"

                  # Calculate checksums
                  # openssl output format: RIPEMD160(MiddleDrag.pkg)= <hash>
                  RMD160=$(openssl dgst -rmd160 MiddleDrag.pkg | awk -F'= ' '{print $2}')
                  SHA256=$(shasum -a 256 MiddleDrag.pkg | awk '{print $1}')
                  SIZE=$(wc -c < MiddleDrag.pkg | tr -d ' ')

                  echo "RMD160: $RMD160"
                  echo "SHA256: $SHA256"
                  echo "SIZE: $SIZE"

                  # Clone ports repo
                  git clone --depth 1 --filter=blob:none --sparse \
                    https://x-access-token:${MACPORTS_PORTS_TOKEN}@github.com/nullpointerdepressivedisorder/macports-ports.git
                  cd macports-ports
                  git sparse-checkout set sysutils/MiddleDrag

                  PORTFILE="sysutils/MiddleDrag/Portfile"

                  if [ ! -f "$PORTFILE" ]; then
                    echo "Error: Portfile not found at $PORTFILE"
                    exit 1
                  fi

                  # Update version
                  sed -i '' "s/version             .*/version             ${VERSION}/" "$PORTFILE"

                  # Update checksums
                  # Assumes the format:
                  # checksums           rmd160  ... \
                  #                     sha256  ... \
                  #                     size    ...
                  sed -i '' "s/rmd160  [0-9a-f]*/rmd160  ${RMD160}/" "$PORTFILE"
                  sed -i '' "s/sha256  [0-9a-f]*/sha256  ${SHA256}/" "$PORTFILE"
                  sed -i '' "s/size    [0-9]*/size    ${SIZE}/" "$PORTFILE"

                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"
                  git add "$PORTFILE"

                  # Check if there are changes before committing
                  if git diff --staged --quiet; then
                    echo "No changes to commit"
                  else
                    git commit -m "Update MiddleDrag to ${VERSION}"
                    git push
                  fi
