# .github/workflows/update-appcast.yml
name: Update Appcast

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to add (e.g., 2.0.1) - leave empty to use latest release"
        required: false
        type: string
  repository_dispatch:
    types: [appcast_release]

permissions:
  contents: write

jobs:
  update-appcast:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine version
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "${{ github.event.client_payload.version }}" ]; then
            VERSION="${{ github.event.client_payload.version }}"
          elif [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=$(gh release view --repo ${{ github.repository }} --json tagName -q '.tagName')
          fi
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Using version: ${VERSION}"

      - name: Download release asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          curl -L -o "MiddleDrag-${VERSION}.pkg" \
            "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/MiddleDrag-${VERSION}.pkg"

      - name: Install Sparkle
        run: |
          curl -L -o Sparkle.tar.xz "https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz"
          mkdir -p Sparkle
          tar -xf Sparkle.tar.xz -C Sparkle

      - name: Generate appcast entry
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_EDDSA_PRIVATE_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PKG_FILE="MiddleDrag-${VERSION}.pkg"
          
          # Get file size
          FILE_SIZE=$(stat -f%z "$PKG_FILE")
          
          # Generate EdDSA signature
          SIGN_OUTPUT=$(echo -n "$SPARKLE_PRIVATE_KEY" | ./Sparkle/bin/sign_update --ed-key-file - "$PKG_FILE" 2>&1)
          if [ $? -ne 0 ]; then
            echo "::error::Failed to generate EdDSA signature: $SIGN_OUTPUT"
            exit 1
          fi
          
          # Extract signature value
          SIGNATURE=$(echo "$SIGN_OUTPUT" | grep -o 'edSignature="[^"]*"' | sed 's/edSignature="//;s/"$//')
          if [ -z "$SIGNATURE" ]; then
            echo "::error::Could not extract signature from: $SIGN_OUTPUT"
            exit 1
          fi
          echo "Signature: ${SIGNATURE:0:20}..."
          
          # Get release notes
          RELEASE_NOTES=$(gh release view "v${VERSION}" --repo ${{ github.repository }} --json body -q '.body' | \
            sed "s/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/\"/\&quot;/g; s/'/\&apos;/g")
          
          PUB_DATE=$(date -R)
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/MiddleDrag-${VERSION}.pkg"
          
          # Create appcast item (write to file to avoid heredoc issues)
          echo "    <item>" > new_item.xml
          echo "      <title>Version ${VERSION}</title>" >> new_item.xml
          echo "      <pubDate>${PUB_DATE}</pubDate>" >> new_item.xml
          echo "      <sparkle:version>${VERSION}</sparkle:version>" >> new_item.xml
          echo "      <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>" >> new_item.xml
          echo "      <description><![CDATA[${RELEASE_NOTES}]]></description>" >> new_item.xml
          echo "      <enclosure url=\"${DOWNLOAD_URL}\" sparkle:edSignature=\"${SIGNATURE}\" length=\"${FILE_SIZE}\" type=\"application/octet-stream\" />" >> new_item.xml
          echo "      <sparkle:minimumSystemVersion>15.0</sparkle:minimumSystemVersion>" >> new_item.xml
          echo "    </item>" >> new_item.xml
          
          echo "Generated appcast entry:"
          cat new_item.xml

      - name: Update appcast.xml
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Create initial appcast if needed
          if [ ! -f appcast.xml ]; then
            echo '<?xml version="1.0" encoding="utf-8"?>' > appcast.xml
            echo '<rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">' >> appcast.xml
            echo '  <channel>' >> appcast.xml
            echo '    <title>MiddleDrag Updates</title>' >> appcast.xml
            echo '    <link>https://middledrag.app</link>' >> appcast.xml
            echo '    <description>Most recent updates to MiddleDrag</description>' >> appcast.xml
            echo '    <language>en</language>' >> appcast.xml
            echo '  </channel>' >> appcast.xml
            echo '</rss>' >> appcast.xml
          fi
          
          # Remove existing entry for this version if present
          if grep -q "sparkle:version>${VERSION}<" appcast.xml; then
            echo "Removing existing entry for ${VERSION}..."
            awk -v ver="${VERSION}" '
              /<item>/ { in_item=1; buffer=$0; next }
              in_item {
                buffer = buffer "\n" $0
                if (/<\/item>/) {
                  if (buffer !~ "sparkle:version>" ver "<") print buffer
                  in_item=0; buffer=""
                }
                next
              }
              { print }
            ' appcast.xml > appcast.xml.tmp && mv appcast.xml.tmp appcast.xml
          fi
          
          # Insert new item after </language>
          sed -i '' "/<\/language>/r new_item.xml" appcast.xml
          rm -f new_item.xml
          
          echo "Updated appcast.xml:"
          cat appcast.xml

      - name: Commit and push
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add appcast.xml
          git commit -m "Update appcast for version ${VERSION}" || echo "No changes to commit"
          git push
